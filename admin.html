<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ICT Ticket Dashboard</title>
    
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="js/auth.js"></script>

    <script>
      // Initialize Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyCsSFQkPN_I3W879JXTCHDZfiH3d-HFqt8",
        authDomain: "visto-35a45.firebaseapp.com",
        projectId: "visto-35a45",
        storageBucket: "visto-35a45.firebasestorage.app",
        messagingSenderId: "699803986836",
        appId: "1:699803986836:web:19522281c3a44f12d73d81",
        measurementId: "G-8R0VTBW1JW",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // --- SESSION SECURITY CHECK ---
      firebase.auth().onAuthStateChanged((user) => {
        if (!user) {
          console.warn("No active session found. Redirecting to login...");
          window.location.href = "login.html";
        }
      });

      document.addEventListener("DOMContentLoaded", async () => {
        try {
          await new Promise(resolve => {
             const unsubscribe = firebase.auth().onAuthStateChanged(user => {
                 unsubscribe();
                 resolve(user);
             });
          });

          const user = firebase.auth().currentUser;
          if (!user) {
             window.location.href = "login.html";
             return;
          }

          await db.collection("users").doc(user.uid).set({
              email: user.email,
              role: 'admin',
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });

          initializeAdminDashboard();

        } catch (error) {
          console.error("[admin] Authentication error:", error);
        }
      });
    </script>

    <style>
      :root {
        /* Emerald & Slate Theme */
        --primary: #10B981;        /* Emerald 500 */
        --primary-hover: #059669;  /* Emerald 600 */
        --primary-soft: #D1FAE5;   /* Emerald 100 */
        
        --slate-900: #0F172A;      /* Deep background/Text */
        --slate-800: #1E293B;      /* Secondary Text */
        --slate-600: #475569;      /* Muted Text */
        --slate-200: #E2E8F0;      /* Borders */
        --slate-50: #F8FAFC;       /* App Background */
        
        --white: #FFFFFF;
        
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        
        --radius-lg: 16px;
        --radius-xl: 24px;
      }

      body {
        background-color: var(--slate-50);
        font-family: 'Inter', sans-serif;
        color: var(--slate-800);
        -webkit-font-smoothing: antialiased;
      }

      /* Glass Navbar */
      .navbar {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--slate-200);
        padding: 1rem 1.5rem;
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .navbar-brand {
        color: var(--slate-900) !important;
        font-weight: 700;
        letter-spacing: -0.02em;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
      }
      
      .navbar-brand i {
        color: var(--primary);
      }

      /* Modern Cards */
      .card {
        background: var(--white);
        border: 1px solid var(--slate-200);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        overflow: hidden;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      /* Stat Cards Specifics */
      .stat-card {
        padding: 1.5rem;
        border-radius: var(--radius-lg);
        position: relative;
        overflow: hidden;
        border: 1px solid var(--slate-200);
        background: var(--white);
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      
      .stat-card h5 {
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--slate-600);
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .stat-card h2 {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--slate-900);
        margin-bottom: 0;
        letter-spacing: -0.03em;
      }
      
      .stat-card .icon-box {
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        opacity: 0.8;
      }

      /* Color Variations for Stats */
      .stat-card.total .icon-box { background: var(--primary-soft); color: var(--primary); }
      .stat-card.pending .icon-box { background: #FEF3C7; color: #D97706; }
      .stat-card.on-process .icon-box { background: #E0F2FE; color: #0284C7; }
      .stat-card.processed .icon-box { background: #DCFCE7; color: #16A34A; }

      .stat-card button {
        margin-top: auto;
        width: 100%;
        border-radius: 8px;
        font-weight: 500;
      }

      /* Sidebar & Chat User List */
      .sidebar {
        background: var(--white);
        border-radius: var(--radius-lg);
        border: 1px solid var(--slate-200);
        padding: 1.5rem;
        height: 100%;
        max-height: 600px;
        display: flex;
        flex-direction: column;
      }

      .users-list {
        overflow-y: auto;
        flex: 1;
        padding-right: 5px;
      }

      .chat-user {
        display: flex;
        align-items: center;
        padding: 10px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 8px;
        border: 1px solid transparent;
      }

      .chat-user:hover {
        background-color: var(--slate-50);
      }

      .chat-user.active {
        background-color: var(--primary-soft);
        border-color: var(--primary);
      }

      .user-avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        margin-right: 12px;
        border: 2px solid var(--white);
        box-shadow: 0 0 0 1px var(--slate-200);
      }

      .user-name {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--slate-900);
      }

      .user-status {
        font-size: 0.75rem;
        color: var(--slate-600);
      }

      .unread-badge {
        background: #EF4444;
        color: white;
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 700;
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
      }

      /* Table Styles */
      .table-responsive {
        border-radius: 12px;
        overflow: hidden;
      }
      
      .table thead th {
        background-color: var(--slate-50);
        color: var(--slate-600);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        border-bottom: 1px solid var(--slate-200);
        padding: 1rem;
      }

      .table tbody td {
        padding: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid var(--slate-200);
        color: var(--slate-800);
        font-size: 0.9rem;
      }
      
      .table-hover tbody tr:hover {
        background-color: var(--slate-50);
      }

      /* Badges */
      .status-badge {
        padding: 6px 12px;
        border-radius: 30px;
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.02em;
      }
      
      .status-pending { background: #ecdfba; color: #B45309; }
      .status-on-process { background: #E0F2FE; color: #0369A1; }
      .status-processed { background: #DCFCE7; color: #15803D; }

      /* Buttons */
      .btn {
        padding: 0.6rem 1.2rem;
        border-radius: 10px;
        font-weight: 500;
        font-size: 0.9rem;
        transition: all 0.2s;
        border: none;
      }

      .btn-success {
        background: linear-gradient(135deg, var(--primary), var(--primary-hover));
        box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2);
      }
      
      .btn-success:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 8px -1px rgba(16, 185, 129, 0.3);
      }

      /* Modal & Chat Interface */
      .modal-content {
        border-radius: var(--radius-xl);
        border: none;
        box-shadow: var(--shadow-lg);
      }

      .modal-header {
        background: var(--white);
        border-bottom: 1px solid var(--slate-200);
        border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        padding: 1.5rem;
      }

      .modal-title {
        font-weight: 700;
        color: var(--slate-900);
      }

      .chat-messages {
        background: var(--slate-50);
        padding: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        max-height: 500px;
        overflow-y: auto;
      }

      .chat-message {
        max-width: 80%;
        display: flex;
        flex-direction: column;
        animation: slideIn 0.3s ease;
      }
      
      @keyframes slideIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .chat-message.admin {
        align-self: flex-end;
      }

      .chat-message.user {
        align-self: flex-start;
      }

      .message-content {
        padding: 12px 18px;
        font-size: 0.95rem;
        line-height: 1.5;
        position: relative;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }

      .chat-message.admin .message-content {
        background: linear-gradient(135deg, var(--primary), var(--primary-hover));
        color: white;
        border-radius: 18px 18px 4px 18px;
      }

      .chat-message.user .message-content {
        background: var(--white);
        color: var(--slate-800);
        border-radius: 18px 18px 18px 4px;
        border: 1px solid var(--slate-200);
      }

      .message-sender {
        font-size: 0.75rem;
        margin-bottom: 4px;
        color: var(--slate-600);
        font-weight: 600;
      }
      
      .message-time {
        font-size: 0.7rem;
        margin-top: 4px;
        opacity: 0.7;
        text-align: right;
      }

      /* Chat Input */
      .chat-input {
        background: var(--white);
        padding: 1.25rem;
        border-top: 1px solid var(--slate-200);
      }

      .chat-input .input-group {
        background: var(--slate-50);
        border-radius: 30px;
        padding: 4px;
        border: 1px solid var(--slate-200);
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
      }

      .chat-input input {
        background: transparent;
        border: none;
        padding-left: 1.5rem;
        font-size: 0.95rem;
      }
      
      .chat-input input:focus {
        background: transparent;
        box-shadow: none;
      }

      .chat-input .btn {
        border-radius: 50%;
        width: 42px;
        height: 42px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 2px;
      }

      /* Inputs General */
      .form-control {
        border-radius: 10px;
        border: 1px solid var(--slate-200);
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
      }
      
      .form-control:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-soft);
      }

      /* Print Styles */
      @media print {
        body * { visibility: hidden; }
        .modal.show, .modal.show * { visibility: visible; }
        .modal.show { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white !important; }
        .btn, .btn-close, .print-hidden { display: none !important; }
        @page { size: portrait; margin: 0.5in; }
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <i class="fas fa-cube me-2"></i> VISTO Admin
        </a>
        <div class="ms-auto d-flex align-items-center gap-3">
          <span class="text-secondary small fw-medium d-none d-md-block">Administrator</span>
          <button id="logoutBtn" class="btn btn-sm btn-outline-secondary rounded-pill px-3">
            <i class="fas fa-sign-out-alt me-1"></i> Logout
          </button>
        </div>
      </div>
    </nav>

    <div class="container-fluid py-5 px-lg-5">

      <div class="row g-4 mb-5">
        <div class="col-xl-3 col-md-6">
          <div class="stat-card total">
            <div class="icon-box"><i class="fas fa-ticket-alt"></i></div>
            <h5>Total Tickets</h5>
            <h2 id="totalTickets">0</h2>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="stat-card pending">
            <div class="icon-box"><i class="fas fa-clock"></i></div>
            <h5>Pending</h5>
            <h2 id="pendingTickets">0</h2>
            <button class="btn btn-warning btn-sm bg-opacity-25 text-white border-0 mt-3" id="viewPendingBtn">
              View List <i class="fas fa-arrow-right ms-1"></i>
            </button>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="stat-card on-process">
            <div class="icon-box"><i class="fas fa-cog fa-spin"></i></div>
            <h5>Processing</h5>
            <h2 id="onProcessTickets">0</h2>
            <button class="btn btn-info btn-sm bg-opacity-25 text-white border-0 mt-3" id="viewOnProcessBtn">
              Track Progress <i class="fas fa-arrow-right ms-1"></i>
            </button>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="stat-card processed">
            <div class="icon-box"><i class="fas fa-check"></i></div>
            <h5>Completed</h5>
            <h2 id="processedCount">0</h2>
            <button class="btn btn-success btn-sm bg-opacity-25 text-white border-0 mt-3" id="viewProcessedBtn">
              History <i class="fas fa-arrow-right ms-1"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="row g-4">
        <div class="col-lg-8">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-header bg-white border-bottom border-light py-3 px-4 d-flex justify-content-between align-items-center">
              <h5 class="fw-bold mb-0 text-dark"><i class="fas fa-inbox me-2 text-primary"></i>Recent Influx</h5>
            </div>
            <div class="card-body p-0">
              <div class="loading-spinner text-center py-5" id="recentTicketsLoading">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted small">Syncing data...</p>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Issue</th>
                      <th>Status</th>
                      <th>User</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="recentTickets"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="sidebar border-0 shadow-sm">
            <h5 class="fw-bold mb-4 text-dark">
              <i class="fas fa-comments me-2 text-primary"></i>Messages
            </h5>
            <div class="loading-spinner text-center" id="usersLoading">
              <div class="spinner-border text-primary spinner-border-sm" role="status"></div>
            </div>
            <div id="usersList" class="users-list pe-2"></div>
          </div>
        </div>
      </div>

      <div class="row g-4 mt-2">
        <div class="col-md-6">
          <div class="card border-0 shadow-sm p-4">
            <h5 class="fw-bold mb-4">Tickets by Department</h5>
            <div style="height: 300px; position: relative; width: 100%;">
                <canvas id="collegeChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card border-0 shadow-sm p-4">
            <h5 class="fw-bold mb-4">Frequent Issues</h5>
            <div style="height: 300px; position: relative; width: 100%;">
                <canvas id="issueChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="chatModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header border-0 pb-0">
            <div>
                <h5 class="modal-title d-flex align-items-center">
                    <span id="chatUserName">User</span>
                </h5>
                <small class="text-muted">Live Support</small>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body p-0 pt-3">
            <div id="ticketInfo" class="px-4 py-2 bg-light border-bottom border-light"></div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
              <div class="input-group">
                <input type="text" class="form-control shadow-none" id="messageInput" placeholder="Type a message..." />
                <button class="btn btn-success text-white" id="sendMessage">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="ticketViewModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Ticket Details</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body px-4 py-4">
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h6 class="text-uppercase text-muted small fw-bold">Ticket ID</h6>
                    <h4 id="ticketId" class="fw-bold text-dark"></h4>
                </div>
                <div class="text-end">
                    <h6 class="text-uppercase text-muted small fw-bold">Date</h6>
                    <span id="ticketTime" class="fw-medium"></span>
                </div>
            </div>

            <div class="p-3 bg-light rounded-3 mb-3">
                <h6 class="fw-bold mb-1">Issue Reported</h6>
                <p id="ticketIssue" class="mb-0 text-primary fw-medium"></p>
            </div>

            <p class="text-muted mb-1"><small>DESCRIPTION</small></p>
            <p id="ticketDescription" class="mb-3"></p>
            
            <div class="row mb-3">
                <div class="col-6">
                    <p class="text-muted mb-1"><small>SCHOOL ID</small></p>
                    <span id="ticketSchoolId" class="fw-medium"></span>
                </div>
                <div class="col-6">
                    <p class="text-muted mb-1"><small>DEPARTMENT</small></p>
                    <span id="ticketDepartment" class="fw-medium"></span>
                </div>
            </div>

            <div class="mb-3 print-hidden">
                <div class="d-flex justify-content-between mb-1">
                    <small class="fw-bold">PROGRESS</small>
                    <small id="ticketProgressLabel"></small>
                </div>
                <div class="progress" style="height: 8px; border-radius: 4px;">
                    <div id="ticketProgress" class="progress-bar bg-success" role="progressbar"></div>
                </div>
            </div>

            <div id="viewRemarksContainer" class="mt-4 pt-3 border-top" style="display:none;">
               <h6 class="fw-bold text-success mb-3"><i class="fas fa-check-circle me-2"></i>Admin Resolution</h6>
               <div class="row g-2 mb-2">
                   <div class="col-6"><small class="text-muted">Processed By:</small> <span id="viewProcessedBy" class="fw-medium"></span></div>
                   <div class="col-6 text-end"><small class="text-muted">Date:</small> <span id="viewDateProcessed" class="fw-medium"></span></div>
               </div>
               <div class="bg-white border rounded p-3">
                   <p class="mb-1"><strong>Problem Found:</strong> <span id="viewRemarkFound"></span></p>
                   <p class="mb-1"><strong>Solution:</strong> <span id="viewRemarkSolution"></span></p>
                   <p class="mb-0"><strong>Recommendation:</strong> <span id="viewRemarkRecommendation"></span></p>
               </div>
            </div>

          </div>
          <div class="modal-footer border-0 pt-0">
            <button class="btn btn-outline-secondary" id="printTicketBtn"><i class="fas fa-print me-2"></i>Print</button>
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="remarkModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Complete Ticket & Add Remarks</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-light border mb-3">
                Processing Ticket: <strong id="remarkTicketId" class="text-primary"></strong>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="remarkProcessedBy" class="form-label small text-uppercase fw-bold text-muted">Processed By</label>
                <input type="text" id="remarkProcessedBy" class="form-control" placeholder="Admin Name" />
              </div>
              <div class="col-md-6">
                <label for="remarkDate" class="form-label small text-uppercase fw-bold text-muted">Date Processed</label>
                <input type="text" id="remarkDate" class="form-control bg-light" readonly />
              </div>
            </div>
            
            <div class="mb-3">
              <label class="form-label small text-uppercase fw-bold text-muted">Problem Found</label>
              <textarea id="remarkFound" class="form-control" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label small text-uppercase fw-bold text-muted">Solution Applied</label>
              <textarea id="remarkSolution" class="form-control" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label small text-uppercase fw-bold text-muted">Recommendation</label>
              <textarea id="remarkRecommendation" class="form-control" rows="2"></textarea>
            </div>
          </div>
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-light text-muted" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="saveRemarkBtn" class="btn btn-success px-4">Save & Complete</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="pendingModal" tabindex="-1">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-warning bg-opacity-10">
            <h5 class="modal-title text-warning text-dark-emphasis">Pending Tickets (<span id="pendingCountModal">0</span>)</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body p-0">
            <div class="loading-spinner p-4 text-center" id="pendingLoadingSpinner">
              <div class="spinner-border text-warning" role="status"></div>
            </div>
            <div id="pendingTableContainer" class="table-responsive">
                <table class="table table-hover mb-0" id="pendingTable">
                    <thead class="bg-light">
                        <tr>
                            <th>ID</th><th>Issue</th><th>By</th><th>Dept</th><th>Time</th><th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="pendingTicketsBody"></tbody>
                </table>
            </div>
          </div>
          <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="onProcessModal" tabindex="-1">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-info bg-opacity-10">
            <h5 class="modal-title text-info text-dark-emphasis">Processing (<span id="onProcessCountModal">0</span>)</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body p-0">
            <div class="loading-spinner p-4 text-center" id="onProcessLoadingSpinner">
               <div class="spinner-border text-info" role="status"></div>
            </div>
            <div id="onProcessTableContainer" class="table-responsive">
                <table class="table table-hover mb-0" id="onProcessTable">
                    <thead class="bg-light">
                        <tr>
                            <th>ID</th><th>Issue</th><th>By</th><th>Dept</th><th>Start Time</th><th>Progress</th><th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="onProcessTicketsBody"></tbody>
                </table>
            </div>
          </div>
          <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="processedModal" tabindex="-1">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-success bg-opacity-10">
            <h5 class="modal-title text-success text-dark-emphasis">Processed History (<span id="processedCountModal">0</span>)</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body p-0">
            <div class="loading-spinner p-4 text-center" id="loadingSpinner">
               <div class="spinner-border text-success" role="status"></div>
            </div>
            <div id="processedTableContainer" class="table-responsive">
                <table class="table table-hover mb-0" id="processedTable">
                    <thead class="bg-light">
                        <tr>
                            <th>ID</th><th>Issue</th><th>By</th><th>Dept</th><th>Date</th><th>Remarks</th><th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="processedTicketsBody"></tbody>
                </table>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-success" id="printProcessedBtn"><i class="fas fa-print"></i> Print</button>
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
      // Enhanced Admin Dashboard Functionality
      
      // Global font default for Chart.js
      Chart.defaults.font.family = "'Inter', sans-serif";
      Chart.defaults.color = '#64748B'; // slate-500

      let currentChatUser = null;
      let messageListener = null;
      let unreadListener = null;
      let _collegeChart = null;
      let _issueChart = null;

      function initializeAdminDashboard() {
        loadDashboardData();
        setupEventListeners();
      }

      function setupEventListeners() {
        // View buttons
        document.getElementById("viewPendingBtn").addEventListener("click", () => {
            loadPendingTickets();
            const pendingModal = new bootstrap.Modal(document.getElementById("pendingModal"));
            pendingModal.show();
        });

        document.getElementById("viewOnProcessBtn").addEventListener("click", () => {
            loadOnProcessTickets();
            const onProcessModal = new bootstrap.Modal(document.getElementById("onProcessModal"));
            onProcessModal.show();
        });

        document.getElementById("viewProcessedBtn").addEventListener("click", () => {
            loadProcessedTickets();
            const processedModal = new bootstrap.Modal(document.getElementById("processedModal"));
            processedModal.show();
        });

        // Print buttons
        document.getElementById("printProcessedBtn").addEventListener("click", () => window.print());
        document.getElementById("printTicketBtn").addEventListener("click", () => window.print());

        // Chat functionality
        document.getElementById("sendMessage").addEventListener("click", sendMessage);
        document.getElementById("messageInput").addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Logout
        const adminLogoutBtn = document.getElementById("logoutBtn");
        if (adminLogoutBtn) adminLogoutBtn.addEventListener("click", () => logout());

        // Remark modal
        const saveRemarkBtn = document.getElementById("saveRemarkBtn");
        if (saveRemarkBtn) saveRemarkBtn.addEventListener("click", saveRemarks);
      }

      function loadDashboardData() {
        loadRecentTickets();
        loadUsers();
        loadTicketStats();
      }

      function loadRecentTickets() {
        const recentTicketsBody = document.getElementById("recentTickets");
        const loadingSpinner = document.getElementById("recentTicketsLoading");

        loadingSpinner.style.display = "block";

        db.collection("tickets")
          .orderBy("createdAt", "desc")
          .limit(10)
          .onSnapshot((snapshot) => {
              recentTicketsBody.innerHTML = "";
              snapshot.forEach((doc) => {
                const ticket = doc.data();
                const statusBadge = getStatusBadge(ticket.status);
                const row = document.createElement("tr");
                row.innerHTML = `
                  <td class="fw-bold text-muted">#${ticket.id}</td>
                  <td class="text-dark fw-medium">${ticket.issue}</td>
                  <td>${statusBadge}</td>
                  <td>
                    <div class="d-flex align-items-center">
                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-2" style="width:30px;height:30px;font-size:0.75rem;font-weight:bold;">
                            ${(ticket.name || "U").charAt(0)}
                        </div>
                        ${ticket.name || "Unknown"}
                    </div>
                  </td>
                  <td>
                    <button class="btn btn-outline-secondary btn-sm view-ticket-btn" 
                            data-ticket='${JSON.stringify(ticket).replace(/'/g, "&#39;")}'>
                      View
                    </button>
                  </td>
                `;
                recentTicketsBody.appendChild(row);
              });
              attachViewTicketListeners();
              loadingSpinner.style.display = "none";
            },
            (error) => {
              console.error("Error loading recent tickets:", error);
              loadingSpinner.style.display = "none";
            }
          );
      }

      async function loadUsers() {
        const usersList = document.getElementById("usersList");
        const loadingSpinner = document.getElementById("usersLoading");

        loadingSpinner.style.display = "block";

        try {
          const ticketsSnapshot = await db.collection("tickets").get();
          const userIds = new Set();
          const ticketsByUser = {};
          const userNames = {};

          ticketsSnapshot.forEach((doc) => {
            const ticket = doc.data();
            if (ticket.userId || ticket.userEmail) {
              const userId = ticket.userId || ticket.userEmail;
              userIds.add(userId);
              if (!ticketsByUser[userId]) ticketsByUser[userId] = [];
              ticketsByUser[userId].push({ ...ticket, id: doc.id });
              userNames[userId] = ticket.name || "Unknown User";
            }
          });

          usersList.innerHTML = "";

          for (const userId of userIds) {
            const userTickets = ticketsByUser[userId] || [];
            const userName = userNames[userId];

            const userElement = document.createElement("div");
            userElement.className = "chat-user";
            userElement.dataset.userId = userId;

            userElement.innerHTML = `
            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=10B981&color=fff&bold=true" class="user-avatar" alt="${userName}">
            <div class="user-info">
              <div class="user-name">${userName}</div>
              <div class="user-status">${userTickets.length} active ticket(s)</div>
            </div>
            <div class="unread-badge d-none">0</div>
          `;

            const userInfo = { id: userId, name: userName, tickets: userTickets };
            userElement.addEventListener("click", () => openChat(userId, userInfo));
            usersList.appendChild(userElement);
          }

          if (usersList.children.length === 0) {
            usersList.innerHTML = '<p class="text-center text-muted p-3 small">No active conversations</p>';
          }

          monitorUnreadMessages();
        } catch (error) {
          console.error("Error loading users:", error);
          usersList.innerHTML = '<p class="text-center text-danger p-3">Error loading users</p>';
        } finally {
          loadingSpinner.style.display = "none";
        }
      }

      function monitorUnreadMessages() {
        if (unreadListener) unreadListener();
        unreadListener = db.collection("chats")
          .where("readByAdmin", "==", false)
          .onSnapshot((snapshot) => {
            const unreadByUser = {};
            snapshot.forEach((doc) => {
              const message = doc.data();
              if (message.senderId !== firebase.auth().currentUser.uid) {
                if (!unreadByUser[message.conversationId]) unreadByUser[message.conversationId] = 0;
                unreadByUser[message.conversationId]++;
              }
            });

            document.querySelectorAll(".chat-user").forEach((item) => {
              const userId = item.dataset.userId;
              const badge = item.querySelector(".unread-badge");
              if (unreadByUser[userId]) {
                badge.classList.remove("d-none");
                badge.textContent = unreadByUser[userId];
              } else {
                badge.classList.add("d-none");
              }
            });
          });
      }

      async function openChat(userId, userData) {
        currentChatUser = userId;
        const chatUserName = document.getElementById("chatUserName");
        const ticketInfo = document.getElementById("ticketInfo");
        const chatMessages = document.getElementById("chatMessages");

        chatUserName.textContent = userData.name;

        ticketInfo.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <span class="text-muted small">Active Tickets:</span>
            <div class="d-flex flex-wrap gap-1 mt-1">
              ${userData.tickets.map((ticket) => `
                <span class="badge bg-light text-dark border fw-normal">#${ticket.id}</span>
              `).join("")}
            </div>
          </div>
        </div>
      `;

        if (messageListener) messageListener();

        messageListener = db.collection("chats")
          .where("conversationId", "==", userId)
          .orderBy("timestamp", "asc")
          .onSnapshot((snapshot) => {
            chatMessages.innerHTML = "";
            const messages = [];
            const batch = db.batch();
            let needsCommit = false;

            snapshot.forEach((doc) => {
              const message = doc.data();
              messages.push({ ...message, id: doc.id, timestamp: message.timestamp?.toDate() || new Date() });
              if (!message.readByAdmin && message.senderType === 'user') {
                  batch.update(db.collection("chats").doc(doc.id), {
                      readByAdmin: true,
                      readAt: firebase.firestore.FieldValue.serverTimestamp()
                  });
                  needsCommit = true;
              }
            });

            if (needsCommit) batch.commit().catch(err => console.error("Error marking read:", err));

            if (messages.length === 0) {
              chatMessages.innerHTML = `
                <div class="text-center text-muted py-5" id="noMessages">
                    <div class="bg-white rounded-circle d-inline-flex p-3 mb-2 shadow-sm"><i class="fas fa-comment-dots text-primary fa-lg"></i></div>
                    <p class="small">Start a conversation with this user.</p>
                </div>`;
            } else {
              messages.forEach((message) => {
                const messageElem = document.createElement("div");
                const isAdmin = message.senderType === 'admin' || message.senderId === firebase.auth().currentUser.uid;
                messageElem.className = `chat-message ${isAdmin ? "admin" : "user"}`;
                messageElem.innerHTML = `
                <div class="message-content">${message.text}</div>
                <div class="message-time">${message.timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
              `;
                chatMessages.appendChild(messageElem);
              });
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
          });

        const chatModal = new bootstrap.Modal(document.getElementById("chatModal"));
        chatModal.show();

        setTimeout(() => document.getElementById("messageInput").focus(), 500);

        document.getElementById("chatModal").addEventListener("hidden.bs.modal", () => {
          if (messageListener) { messageListener(); messageListener = null; }
          currentChatUser = null;
          document.querySelectorAll(".chat-user").forEach((user) => user.classList.remove("active"));
        });

        document.querySelectorAll(".chat-user").forEach((user) => {
          user.classList.remove("active");
          if (user.dataset.userId === userId) user.classList.add("active");
        });
      }

      async function sendMessage() {
        const messageInput = document.getElementById("messageInput");
        const message = messageInput.value.trim();

        if (message && currentChatUser) {
          try {
            await db.collection("chats").add({
              conversationId: currentChatUser,
              text: message,
              senderId: firebase.auth().currentUser.uid,
              senderName: "Admin",
              senderType: "admin",
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
              readByUser: false,
              readByAdmin: true,
            });
            messageInput.value = "";
          } catch (error) {
            console.error("Error sending message:", error);
            alert("Failed to send message");
          }
        }
      }

      function getStatusBadge(status) {
        const s = status.toLowerCase();
        if(s === 'pending') return `<span class="status-badge status-pending">Pending</span>`;
        if(s === 'on-process' || s === 'on process') return `<span class="status-badge status-on-process">Processing</span>`;
        if(s === 'processed') return `<span class="status-badge status-processed">Completed</span>`;
        return `<span class="badge bg-secondary">${status}</span>`;
      }

      function loadTicketStats() {
        db.collection("tickets").onSnapshot((snapshot) => {
            let total = 0, pending = 0, onProcess = 0, processed = 0;
            const collegeCounts = {};
            const issueCounts = {};

            snapshot.forEach((doc) => {
              const ticket = doc.data();
              total++;
              
              // Clean and standardize Data (Fixes duplicate bars for same name)
              const dept = ticket.department ? ticket.department.trim() : "Unknown";
              const iss = ticket.issue ? ticket.issue.trim() : "Other";
              
              collegeCounts[dept] = (collegeCounts[dept] || 0) + 1;
              issueCounts[iss] = (issueCounts[iss] || 0) + 1;

              // Status Counter
              const s = ticket.status ? ticket.status.toLowerCase() : "";
              if (s === "pending") pending++;
              else if (s === "on process" || s === "on-process") onProcess++;
              else if (s === "processed") processed++;
            });

            // Update Scorecards
            document.getElementById("totalTickets").textContent = total;
            document.getElementById("pendingTickets").textContent = pending;
            document.getElementById("onProcessTickets").textContent = onProcess;
            document.getElementById("processedCount").textContent = processed;

            // Render Charts
            try { 
                renderCollegeChart(collegeCounts); 
                renderIssueChart(issueCounts); 
            } catch (err) { 
                console.warn("Chart rendering error:", err); 
            }
          },
          (error) => console.error("Error loading ticket stats:", error)
        );
      }

      function renderCollegeChart(counts) {
        const chartCanvas = document.getElementById("collegeChart");
        if (!chartCanvas) return;

        // Destroy existing chart to prevent glitches
        if (_collegeChart) {
            _collegeChart.destroy();
        }

        const ctx = chartCanvas.getContext("2d");
        
        // Sort data: Highest count first
        const labels = Object.keys(counts).sort((a, b) => counts[b] - counts[a]);
        const data = labels.map((l) => counts[l]);

        // Fallback for empty data
        if (labels.length === 0) { 
            labels.push("No Data"); 
            data.push(0); 
        }

        _collegeChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [{ 
                label: "Tickets", 
                data: data, 
                backgroundColor: "#10B981", // Emerald 500
                hoverBackgroundColor: "#059669", // Emerald 600
                borderRadius: 6,
                barPercentage: 0.6,
            }],
          },
          options: {
            indexAxis: "y", // Horizontal Bar
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#1E293B',
                    padding: 12,
                    cornerRadius: 8,
                    displayColors: false,
                }
            },
            layout: { padding: { left: 0, right: 20, top: 0, bottom: 0 } },
            scales: {
              x: { 
                  beginAtZero: true, 
                  grid: { display: false }, 
                  ticks: { stepSize: 1 } 
              },
              y: { 
                  grid: { display: false },
                  ticks: {
                      font: { weight: 500 }
                  }
              },
            },
          },
        });
      }

      function renderIssueChart(counts) {
        const chartCanvas = document.getElementById("issueChart");
        if (!chartCanvas) return;

        // Destroy existing chart
        if (_issueChart) {
            _issueChart.destroy();
        }

        const ctx = chartCanvas.getContext("2d");
        
        // Sort and slice (Top 10 issues only)
        const labels = Object.keys(counts).sort((a, b) => counts[b] - counts[a]).slice(0, 10);
        const data = labels.map((l) => counts[l]);

        if (labels.length === 0) { 
            labels.push("No Data"); 
            data.push(0); 
        }

        _issueChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [{ 
                label: "Occurrences", 
                data: data, 
                backgroundColor: "#0EA5E9", // Sky 500
                hoverBackgroundColor: "#0284C7", // Sky 600
                borderRadius: 6,
                barPercentage: 0.6,
            }],
          },
          options: {
            indexAxis: "y",
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#1E293B',
                    padding: 12,
                    cornerRadius: 8,
                    displayColors: false,
                }
            },
            layout: { padding: { left: 0, right: 20, top: 0, bottom: 0 } },
            scales: {
              x: { 
                  beginAtZero: true, 
                  grid: { display: false },
                  ticks: { stepSize: 1 } 
              },
              y: { 
                  grid: { display: false },
                  ticks: {
                      font: { weight: 500 }
                  }
              },
            },
          },
        });
      }

      function attachViewTicketListeners() {
        document.querySelectorAll(".view-ticket-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const ticketData = JSON.parse(btn.dataset.ticket.replace(/&#39;/g, "'"));
            document.getElementById("ticketId").textContent = ticketData.id;
            document.getElementById("ticketIssue").textContent = ticketData.issue;
            document.getElementById("ticketDescription").textContent = ticketData.description || "No description available";
            document.getElementById("ticketSchoolId").textContent = ticketData.schoolId || "N/A";
            document.getElementById("ticketDepartment").textContent = ticketData.department || "N/A";
            document.getElementById("ticketTime").textContent = ticketData.createdAt ? new Date(ticketData.createdAt.seconds * 1000).toLocaleString() : "N/A";
            const progress = ticketData.progress || 0;
            document.getElementById("ticketProgress").style.width = progress + "%";
            document.getElementById("ticketProgressLabel").textContent = progress + "%";

            const remarksContainer = document.getElementById("viewRemarksContainer");
            if (ticketData.remarks) {
                document.getElementById("viewProcessedBy").textContent = ticketData.remarks.processedBy || "N/A";
                document.getElementById("viewDateProcessed").textContent = ticketData.remarks.dateProcessed || "N/A";
                document.getElementById("viewRemarkFound").textContent = ticketData.remarks.found || "N/A";
                document.getElementById("viewRemarkSolution").textContent = ticketData.remarks.solution || "N/A";
                document.getElementById("viewRemarkRecommendation").textContent = ticketData.remarks.recommendation || "N/A";
                remarksContainer.style.display = "block";
            } else {
                remarksContainer.style.display = "none";
            }

            const ticketModal = new bootstrap.Modal(document.getElementById("ticketViewModal"));
            ticketModal.show();
          });
        });
      }

      function loadPendingTickets() {
        const pendingTicketsBody = document.getElementById("pendingTicketsBody");
        const loadingSpinner = document.getElementById("pendingLoadingSpinner");
        const pendingTableContainer = document.getElementById("pendingTableContainer");

        loadingSpinner.style.display = "block";
        pendingTableContainer.style.display = "none";

        db.collection("tickets").orderBy("createdAt", "desc").onSnapshot((snapshot) => {
            pendingTicketsBody.innerHTML = "";
            let count = 0;
            snapshot.forEach((doc) => {
              const ticket = doc.data();
              const s = ticket.status ? ticket.status.toLowerCase() : "";
              if (s === "pending") {
                const row = document.createElement("tr");
                row.innerHTML = `
                  <td class="fw-bold text-muted">#${ticket.id}</td>
                  <td>${ticket.issue}</td>
                  <td>${ticket.name || "Unknown"}</td>
                  <td>${ticket.department}</td>
                  <td class="small text-muted">${ticket.time || "N/A"}</td>
                  <td><button class="btn btn-success btn-sm process-ticket-btn shadow-sm" data-doc-id="${doc.id}">Process</button></td>
                `;
                pendingTicketsBody.appendChild(row);
                count++;
              }
            });
            if (count === 0) pendingTicketsBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No pending tickets found</td></tr>';
            document.getElementById("pendingCountModal").textContent = count;
            loadingSpinner.style.display = "none";
            pendingTableContainer.style.display = "block";
            attachProcessTicketListeners();
          },
          (error) => loadPendingTicketsAlternative()
        );
      }
      
      // Fallback function for Pending
      function loadPendingTicketsAlternative() {
        const pendingTicketsBody = document.getElementById("pendingTicketsBody");
        const loadingSpinner = document.getElementById("pendingLoadingSpinner");
        const pendingTableContainer = document.getElementById("pendingTableContainer");
        db.collection("tickets").get().then((snapshot) => {
            pendingTicketsBody.innerHTML = "";
            let count = 0;
            const tickets = [];
            snapshot.forEach((doc) => {
                const ticket = doc.data();
                if(ticket.status && ticket.status.toLowerCase() === 'pending') tickets.push({ ...ticket, docId: doc.id });
            });
            tickets.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            tickets.forEach((ticket) => {
                 const row = document.createElement("tr");
                 row.innerHTML = `<td>${ticket.id}</td><td>${ticket.issue}</td><td>${ticket.name||""}</td><td>${ticket.department}</td><td>${ticket.time||""}</td><td><button class="btn btn-success btn-sm process-ticket-btn" data-doc-id="${ticket.docId}">Process</button></td>`;
                 pendingTicketsBody.appendChild(row);
                 count++;
            });
            if(count===0) pendingTicketsBody.innerHTML = '<tr><td colspan="6" class="text-center">No pending tickets</td></tr>';
            document.getElementById("pendingCountModal").textContent = count;
            loadingSpinner.style.display="none"; pendingTableContainer.style.display="block";
            attachProcessTicketListeners();
        });
      }

      function loadOnProcessTickets() {
        const onProcessTicketsBody = document.getElementById("onProcessTicketsBody");
        const loadingSpinner = document.getElementById("onProcessLoadingSpinner");
        const onProcessTableContainer = document.getElementById("onProcessTableContainer");

        loadingSpinner.style.display = "block";
        onProcessTableContainer.style.display = "none";

        db.collection("tickets").orderBy("createdAt", "desc").onSnapshot((snapshot) => {
            onProcessTicketsBody.innerHTML = "";
            let count = 0;
            snapshot.forEach((doc) => {
              const ticket = doc.data();
              const s = ticket.status ? ticket.status.toLowerCase() : "";
              if (s === "on process" || s === "on-process") {
                const row = document.createElement("tr");
                row.innerHTML = `
                  <td class="fw-bold text-muted">#${ticket.id}</td>
                  <td>${ticket.issue}</td>
                  <td>${ticket.name || "Unknown"}</td>
                  <td>${ticket.department}</td>
                  <td class="small text-muted">${ticket.time || "N/A"}</td>
                  <td style="width: 15%">
                    <div class="progress" style="height: 6px;">
                      <div class="progress-bar ${getProgressColor(ticket.progress)}" role="progressbar" style="width: ${ticket.progress || 0}%"></div>
                    </div>
                  </td>
                  <td><button class="btn btn-success btn-sm complete-ticket-btn shadow-sm" data-doc-id="${doc.id}">Done</button></td>
                `;
                onProcessTicketsBody.appendChild(row);
                count++;
              }
            });
            if (count === 0) onProcessTicketsBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No active tickets</td></tr>';
            document.getElementById("onProcessCountModal").textContent = count;
            loadingSpinner.style.display = "none";
            onProcessTableContainer.style.display = "block";
            attachCompleteTicketListeners();
          },
          (error) => loadOnProcessTicketsAlternative()
        );
      }
      
      // Fallback for On Process
      function loadOnProcessTicketsAlternative() {
          const body = document.getElementById("onProcessTicketsBody");
          const spinner = document.getElementById("onProcessLoadingSpinner");
          const container = document.getElementById("onProcessTableContainer");
          db.collection("tickets").get().then((snap) => {
              body.innerHTML=""; let count=0; const tickets=[];
              snap.forEach(doc=>{ const t=doc.data(); const s=t.status?t.status.toLowerCase():""; if(s==="on process"||s==="on-process") tickets.push({...t, docId:doc.id}); });
              tickets.forEach(t=>{
                  const row = document.createElement("tr");
                  row.innerHTML = `<td>${t.id}</td><td>${t.issue}</td><td>${t.name||""}</td><td>${t.department}</td><td>${t.time||""}</td><td>${t.progress}%</td><td><button class="btn btn-success btn-sm complete-ticket-btn" data-doc-id="${t.docId}">Done</button></td>`;
                  body.appendChild(row); count++;
              });
              document.getElementById("onProcessCountModal").textContent=count;
              spinner.style.display="none"; container.style.display="block";
              attachCompleteTicketListeners();
          });
      }

      function loadProcessedTickets() {
        const processedTicketsBody = document.getElementById("processedTicketsBody");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const processedTableContainer = document.getElementById("processedTableContainer");

        loadingSpinner.style.display = "block";
        processedTableContainer.style.display = "none";

        db.collection("tickets").orderBy("createdAt", "desc").onSnapshot((snapshot) => {
            processedTicketsBody.innerHTML = "";
            let count = 0;
            snapshot.forEach((doc) => {
              const ticket = doc.data();
              const s = ticket.status ? ticket.status.toLowerCase() : "";
              if (s === "processed") {
                const remarkSnippet = ticket.remarks ? (ticket.remarks.found || ticket.remarks.solution || "") : "";
                const row = document.createElement("tr");
                row.innerHTML = `
                  <td class="fw-bold text-muted">#${ticket.id}</td>
                  <td>${ticket.issue}</td>
                  <td>${ticket.name || "Unknown"}</td>
                  <td>${ticket.department}</td>
                  <td class="small text-muted">${ticket.dateProcessed || new Date().toLocaleDateString()}</td>
                  <td class="text-truncate" style="max-width: 150px;">${remarkSnippet}</td>
                  <td><button class="btn btn-sm btn-outline-success processed-view-btn" data-doc-id="${doc.id}">View</button></td>
                `;
                processedTicketsBody.appendChild(row);
                count++;
              }
            });
            if (count === 0) processedTicketsBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No processed history</td></tr>';
            attachProcessedViewListeners();
            document.getElementById("processedCount").textContent = count;
            document.getElementById("processedCountModal").textContent = count;
            loadingSpinner.style.display = "none";
            processedTableContainer.style.display = "block";
          },
          (error) => loadProcessedTicketsAlternative()
        );
      }
      
      // Fallback for Processed
      function loadProcessedTicketsAlternative() {
          const body = document.getElementById("processedTicketsBody");
          const spinner = document.getElementById("loadingSpinner");
          const container = document.getElementById("processedTableContainer");
          db.collection("tickets").get().then((snap) => {
              body.innerHTML=""; let count=0;
              snap.forEach(doc=>{
                  const t=doc.data(); const s=t.status?t.status.toLowerCase():"";
                  if(s==="processed") {
                      const row=document.createElement("tr");
                      row.innerHTML=`<td>${t.id}</td><td>${t.issue}</td><td>${t.name||""}</td><td>${t.department}</td><td>${t.dateProcessed||""}</td><td>-</td><td><button class="btn btn-sm btn-outline-success processed-view-btn" data-doc-id="${doc.id}">View</button></td>`;
                      body.appendChild(row); count++;
                  }
              });
              document.getElementById("processedCount").textContent=count;
              document.getElementById("processedCountModal").textContent=count;
              attachProcessedViewListeners();
              spinner.style.display="none"; container.style.display="block";
          });
      }

      async function processTicket(docId) {
        try {
          await db.collection("tickets").doc(docId).update({ status: "on-process", progress: 50 });
          showNotification("Ticket moved to On Process", "success");
        } catch (error) {
          console.error("Error processing ticket:", error);
          showNotification("Error processing ticket", "error");
        }
      }

      async function completeTicket(docId) {
        try {
          const doc = await db.collection("tickets").doc(docId).get();
          const ticket = doc.data();

          document.getElementById("remarkTicketId").textContent = ticket.id || "";
          document.getElementById("remarkFound").value = ticket.remarks ? ticket.remarks.found || "" : "";
          document.getElementById("remarkSolution").value = ticket.remarks ? ticket.remarks.solution || "" : "";
          document.getElementById("remarkRecommendation").value = ticket.remarks ? ticket.remarks.recommendation || "" : "";
          
          document.getElementById("remarkDate").value = new Date().toLocaleString();
          document.getElementById("saveRemarkBtn").dataset.docId = docId;

          const remarkModal = new bootstrap.Modal(document.getElementById("remarkModal"));
          remarkModal.show();
        } catch (error) {
          console.error("Error opening remark modal:", error);
          showNotification("Error opening remark modal", "error");
        }
      }

      function attachProcessTicketListeners() {
        document.querySelectorAll(".process-ticket-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => processTicket(e.target.dataset.docId));
        });
      }

      function attachCompleteTicketListeners() {
        document.querySelectorAll(".complete-ticket-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => completeTicket(e.target.dataset.docId));
        });
      }

      function attachProcessedViewListeners() {
        document.querySelectorAll(".processed-view-btn").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const docId = e.target.dataset.docId;
            try {
              const snap = await db.collection("tickets").doc(docId).get();
              const ticket = snap.data();
              if (!ticket) return alert("Ticket not found");
              
              document.getElementById("ticketId").textContent = ticket.id;
              document.getElementById("ticketIssue").textContent = ticket.issue;
              document.getElementById("ticketDescription").textContent = ticket.description || "No description available";
              document.getElementById("ticketSchoolId").textContent = ticket.schoolId || "N/A";
              document.getElementById("ticketDepartment").textContent = ticket.department || "N/A";
              document.getElementById("ticketTime").textContent = ticket.createdAt ? new Date(ticket.createdAt.seconds*1000).toLocaleString() : (ticket.time || "N/A");
              document.getElementById("ticketProgress").style.width = "100%";
              
              const remarksContainer = document.getElementById("viewRemarksContainer");
              if(ticket.remarks) {
                  document.getElementById("viewProcessedBy").textContent = ticket.remarks.processedBy || "N/A";
                  document.getElementById("viewDateProcessed").textContent = ticket.remarks.dateProcessed || "N/A";
                  document.getElementById("viewRemarkFound").textContent = ticket.remarks.found || "N/A";
                  document.getElementById("viewRemarkSolution").textContent = ticket.remarks.solution || "N/A";
                  document.getElementById("viewRemarkRecommendation").textContent = ticket.remarks.recommendation || "N/A";
                  remarksContainer.style.display = "block";
              } else {
                  remarksContainer.style.display = "none";
              }

              const ticketModal = new bootstrap.Modal(document.getElementById("ticketViewModal"));
              ticketModal.show();
            } catch (err) {
              console.error("Error fetching ticket:", err);
            }
          });
        });
      }

      function getProgressColor(p) {
        if (p >= 100) return "bg-success";
        if (p >= 60) return "bg-info";
        return "bg-warning";
      }

      async function saveRemarks() {
        const docId = document.getElementById("saveRemarkBtn").dataset.docId;
        if (!docId) return showNotification("No ticket selected", "error");

        const found = document.getElementById("remarkFound").value.trim();
        const solution = document.getElementById("remarkSolution").value.trim();
        const recommendation = document.getElementById("remarkRecommendation").value.trim();
        const processedBy = document.getElementById("remarkProcessedBy").value.trim();
        const dateProcessed = document.getElementById("remarkDate").value;

        try {
          await db.collection("tickets").doc(docId).update({
            status: "processed",
            progress: 100,
            finishedAt: firebase.firestore.FieldValue.serverTimestamp(),
            remarks: {
              found: found,
              solution: solution,
              recommendation: recommendation,
              processedBy: processedBy,
              dateProcessed: dateProcessed,
              by: (firebase.auth().currentUser && firebase.auth().currentUser.uid) || null,
              at: firebase.firestore.FieldValue.serverTimestamp(),
            },
          });

          const ticketSnap = await db.collection("tickets").doc(docId).get();
          const ticket = ticketSnap.data();
          if (ticket && ticket.userId) {
            await db.collection("notifications").add({
              userId: ticket.userId,
              ticketId: docId,
              message: `Your ticket (${ticket.id || docId}) has been completed.`,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              read: false,
            });
          }

          const remarkModal = bootstrap.Modal.getInstance(document.getElementById("remarkModal"));
          remarkModal.hide();
          showNotification("Ticket completed successfully!", "success");
        } catch (err) {
          console.error("Error saving remarks:", err);
          showNotification("Failed to save remarks", "error");
        }
      }

      function showNotification(message, type = "info") {
        const alertClass = type === "success" ? "alert-success" : type === "error" ? "alert-danger" : "alert-info";
        const notification = document.createElement("div");
        notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed shadow-lg border-0`;
        notification.style.cssText = "top: 20px; right: 20px; z-index: 9999; min-width: 300px; border-radius: 12px;";
        notification.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        document.body.appendChild(notification);
        setTimeout(() => { if (notification.parentNode) notification.remove(); }, 5000);
      }
    </script>
  </body>
</html>