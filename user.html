<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VISTO — User Portal</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet" />

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script src="js/auth.js"></script>

    <script>
      // 1. Initialize Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyCsSFQkPN_I3W879JXTCHDZfiH3d-HFqt8",
        authDomain: "visto-35a45.firebaseapp.com",
        projectId: "visto-35a45",
        storageBucket: "visto-35a45.firebasestorage.app",
        messagingSenderId: "699803986836",
        appId: "1:699803986836:web:19522281c3a44f12d73d81",
        measurementId: "G-8R0VTBW1JW",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // 2. Initialize EmailJS
      (function() {
          // REPLACE THIS WITH YOUR ACTUAL PUBLIC KEY FROM EMAILJS DASHBOARD
          emailjs.init("-MLS89N-SQ0aUPGNk"); 
      })();

      // --- SESSION SECURITY CHECK ---
      firebase.auth().onAuthStateChanged((user) => {
        if (!user) {
          console.warn("No active session found. Redirecting to login...");
          window.location.href = "login.html";
        }
      });

      // Check if user is authenticated and is a regular user
      document.addEventListener("DOMContentLoaded", async () => {
        const waitForAuthReady = async (timeout = 3000) => {
          const start = Date.now();
          while (window.isAuthLoading === undefined || window.isAuthLoading) {
            if (Date.now() - start > timeout) break;
            await new Promise((r) => setTimeout(r, 100));
          }
        };

        await waitForAuthReady();

        try {
          await checkUserType("user");
        } catch (err) {
          console.error("Non-fatal checkUserType error:", err);
        }
      });
    </script>

    <style>
      :root {
        --primary-color: #10b981; /* Emerald */
        --primary-dark: #059669;
        --primary-light: #d1fae5;
        --bg-color: #f3f4f6;
        --text-main: #111827;
        --text-muted: #6b7280;
        --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
        --border-radius: 16px;
      }

      body {
        background-color: var(--bg-color);
        font-family: "Inter", sans-serif;
        color: var(--text-main);
        min-height: 100vh;
        padding-bottom: 80px; /* Space for floating button */
      }

      h1, h2, h3, h4, h5, h6, .navbar-brand {
        font-family: "Poppins", sans-serif;
      }

      /* Navbar */
      .navbar {
        background-color: #ffffff;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        padding: 1rem 1.5rem;
      }

      .navbar-brand {
        color: var(--primary-color) !important;
        font-weight: 800;
        font-size: 1.5rem;
        letter-spacing: -0.5px;
      }

      .user-badge {
        background-color: var(--primary-light);
        color: var(--primary-dark);
        border-radius: 20px;
        padding: 6px 16px;
        font-weight: 600;
        font-size: 0.85rem;
      }

      .btn-logout {
        color: var(--text-muted);
        font-weight: 500;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 6px 16px;
        transition: all 0.2s;
      }

      .btn-logout:hover {
        background-color: #f9fafb;
        color: var(--text-main);
      }

      /* Cards */
      .card {
        border: 1px solid #e5e7eb;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        background: white;
        transition: transform 0.2s ease;
        overflow: hidden;
      }

      .card-header-custom {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
      }

      .card-title {
        font-weight: 700;
        color: var(--text-main);
        margin: 0;
        font-size: 1.15rem;
      }

      /* Form Elements */
      .form-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.4rem;
      }

      .form-control, .form-select {
        border-radius: 10px;
        border: 1px solid #d1d5db;
        padding: 0.7rem 1rem;
        font-size: 0.95rem;
        background-color: #f9fafb;
        transition: all 0.2s;
      }

      .form-control:focus, .form-select:focus {
        background-color: white;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
      }

      .btn-success {
        background-color: var(--primary-color);
        border: none;
        border-radius: 10px;
        padding: 10px 24px;
        font-weight: 600;
        transition: all 0.2s;
      }

      .btn-success:hover {
        background-color: var(--primary-dark);
        transform: translateY(-1px);
      }

      /* Tickets List */
      .ticket-row {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        display: flex;
        gap: 15px;
        align-items: flex-start;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .ticket-row:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        border-color: var(--primary-color);
      }

      .ticket-thumb {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 10px;
        background: #f3f4f6;
      }

      .ticket-meta {
        flex: 1;
      }

      .ticket-id {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
        font-weight: 600;
        margin-bottom: 4px;
      }

      .ticket-issue {
        font-weight: 600;
        font-size: 1rem;
        color: var(--text-main);
        margin-bottom: 4px;
      }

      .ticket-desc {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-bottom: 8px;
        line-height: 1.4;
      }

      /* Status Badges */
      .badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.75rem;
        letter-spacing: 0.3px;
      }
      
      .bg-warning { background-color: #fef3c7 !important; color: #92400e !important; }
      .bg-info { background-color: #e0f2fe !important; color: #075985 !important; }
      .bg-success { background-color: #d1fae5 !important; color: #065f46 !important; }

      /* Chat Interface */
      .chat-container {
        background: #f9fafb;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        height: 350px;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .chat-message {
        display: flex;
        flex-direction: column;
        max-width: 80%;
      }

      .chat-message.user {
        align-self: flex-end;
        align-items: flex-end;
      }

      .chat-message.admin {
        align-self: flex-start;
        align-items: flex-start;
      }

      .message-content {
        padding: 10px 16px;
        border-radius: 18px;
        font-size: 0.9rem;
        line-height: 1.5;
        position: relative;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }

      .chat-message.user .message-content {
        background-color: var(--primary-color);
        color: white;
        border-bottom-right-radius: 4px;
      }

      .chat-message.admin .message-content {
        background-color: white;
        color: var(--text-main);
        border: 1px solid #e5e7eb;
        border-bottom-left-radius: 4px;
      }

      .message-time {
        font-size: 0.7rem;
        margin-top: 4px;
        opacity: 0.8;
      }

      .chat-input-area {
        margin-top: 1rem;
        background: white;
        border-radius: 12px;
        padding: 8px;
        border: 1px solid #e5e7eb;
        display: flex;
        gap: 10px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
      }

      .chat-input-area input {
        border: none;
        box-shadow: none;
        background: transparent;
      }

      /* Floating AI Button */
      #geminiChatBtn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4f46e5, #818cf8);
        box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
        color: white;
        font-size: 1.8rem;
        z-index: 1050;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #geminiChatBtn:hover {
        transform: scale(1.1) rotate(10deg);
      }

      /* AI Chat Modal Styling */
      #geminiModalContent {
        background-color: #f8fafc;
      }
      .gemini-message.assistant .gemini-message-content {
        background-color: white;
        border: 1px solid #e2e8f0;
        color: #334155;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }
      .gemini-message.user .gemini-message-content {
        background: linear-gradient(135deg, #4f46e5, #6366f1);
      }

      /* Loading & Empty States */
      .loading-spinner { text-align: center; padding: 2rem; color: var(--text-muted); }
      .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-muted); }
      .empty-state i { font-size: 3rem; color: #d1d5db; margin-bottom: 1rem; display: block; }

      /* Responsive */
      @media (max-width: 991px) {
        .container-fluid { padding: 1rem; }
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg sticky-top">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <i class="bi bi-ticket-detailed-fill me-2"></i>VISTO
        </a>
        <div class="ms-auto d-flex align-items-center gap-3">
          <div class="d-none d-md-block text-muted small">Signed in as</div>
          <div class="user-badge" id="user-badge">Guest</div>
          <button id="logoutBtn" class="btn btn-logout btn-sm">
            <i class="bi bi-box-arrow-right me-1"></i> Logout
          </button>
        </div>
      </div>
    </nav>

    <div class="container py-5">

      <div class="row g-4">
        <div class="col-lg-8">
          
          <div class="card p-4 mb-4">
            <div class="card-header-custom">
              <h5 class="card-title"><i class="bi bi-plus-circle-fill text-success me-2"></i>New Ticket</h5>
              <small class="text-muted">All fields marked required</small>
            </div>

            <form id="ticketForm" class="row gy-3">
              <div class="col-md-6">
                <label class="form-label">Full Name</label>
                <input required id="name" class="form-control" placeholder="e.g. Juan Dela Cruz" />
              </div>

              <div class="col-md-6">
                <label class="form-label">School ID</label>
                <input required id="schoolId" class="form-control" placeholder="2025-xxxx" />
              </div>

              <div class="col-md-6">
                <label class="form-label">Department</label>
                <select required id="department" class="form-select">
                  <option value="">Select Department...</option>
                  <option value="CCS">CCS</option>
                  <option value="IABE">IABE</option>
                  <option value="CAAF">CAAF</option>
                  <option value="CAS">CAS</option>
                  <option value="CBM">CBM</option>
                  <option value="CTE">CTE</option>
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label">Timestamp</label>
                <input id="timeField" class="form-control text-muted" readonly style="background-color: #e9ecef;" />
              </div>

              <div class="col-12">
                <label class="form-label">Issue Category</label>
                <select id="issueSelect" class="form-select" required>
                  <option value="">What type of issue are you facing?</option>
                  <option value="Network Connectivity">Network Connectivity</option>
                  <option value="Repair/Troubleshoot">Repair/Troubleshoot</option>
                  <option value="Formatting">Formatting</option>
                  <option value="Software Installation">Software Installation</option>
                  <option value="Internet Service">Internet Service</option>
                  <option value="Other">Other</option>
                </select>
              </div>

              <div class="col-12">
                <label class="form-label">Description</label>
                <textarea required id="description" class="form-control" rows="3" placeholder="Please describe the details of your problem..."></textarea>
              </div>

              <div class="col-md-8">
                <label class="form-label">Attachment (Optional)</label>
                <input id="imageInput" accept="image/*" class="form-control" type="file" />
                <div class="mt-3" id="imagePreviewWrap" style="display: none">
                  <img id="imagePreview" style="max-height: 120px; border-radius: 8px; border: 1px solid #dee2e6;" />
                  <div class="small text-muted mt-1">Preview</div>
                </div>
              </div>

              <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-success w-100 h-100" style="max-height: 42px;">
                  Submit Ticket
                </button>
              </div>
            </form>
          </div>

          <div class="card p-4 mb-4">
            <div class="card-header-custom">
              <h5 class="card-title"><i class="bi bi-list-task text-primary me-2"></i>My Tickets</h5>
              <button id="clearAll" class="btn btn-sm btn-light text-danger border-0">
                <i class="bi bi-trash"></i> Clear All
              </button>
            </div>

            <div class="loading-spinner" id="ticketsLoading">
              <div class="spinner-border text-success" role="status"></div>
              <p class="mt-2 small">Fetching tickets...</p>
            </div>

            <div id="ticketsList"></div>

            <div id="noTickets" class="empty-state" style="display: none">
              <i class="bi bi-clipboard-x"></i>
              <div class="mt-2">No active tickets found.</div>
            </div>
          </div>

        </div>

        <div class="col-lg-4">
            <div class="card p-4 sticky-top" style="top: 90px; z-index: 1;">
                <div class="card-header-custom">
                  <h5 class="card-title"><i class="bi bi-chat-dots-fill text-info me-2"></i>Admin Support</h5>
                </div>
    
                <div class="chat-messages chat-container" id="chatMessages">
                  <div class="empty-state" id="noMessages">
                    <i class="bi bi-chat-square-text"></i>
                    <div class="mt-2">Start a conversation with the admin.</div>
                  </div>
                </div>
    
                <div class="chat-input-area">
                  <input type="text" class="form-control" id="messageInput" placeholder="Type your message here..." />
                  <button class="btn btn-success rounded-circle" id="sendMessage" style="width: 40px; height: 40px; padding: 0;">
                    <i class="bi bi-send-fill"></i>
                  </button>
                </div>
                <div class="mt-2 text-end">
                  <small class="text-muted" style="font-size: 0.75rem;">Messages are visible to all admins</small>
                </div>
              </div>
        </div>
      </div>
    </div>

    <button id="geminiChatBtn" class="btn" data-bs-toggle="modal" data-bs-target="#geminiChatModal" title="Ask AI Assistant">
      <i class="bi bi-robot"></i>
    </button>

    <div class="modal fade" id="ticketViewModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg">
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-bold">Ticket Details</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body p-4">
            <div class="row g-4">
              <div class="col-md-7">
                <div class="mb-4">
                    <h4 id="viewIssue" class="fw-bold text-primary mb-2">Issue Title</h4>
                    <span class="badge bg-light text-dark border" id="viewTime">Time</span>
                </div>
                
                <div class="p-3 bg-light rounded-3 mb-3">
                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Description</small>
                    <p id="viewDesc" class="mb-0 mt-1 text-dark"></p>
                </div>

                <div class="row g-2 text-sm">
                    <div class="col-6">
                        <small class="text-muted">Submitted By</small>
                        <div class="fw-bold" id="viewName"></div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">School ID</small>
                        <div class="fw-bold" id="viewSchoolId"></div>
                    </div>
                    <div class="col-12">
                          <small class="text-muted">Department</small>
                          <div class="fw-bold" id="viewDepartment"></div>
                    </div>
                </div>
              </div>

              <div class="col-md-5 text-center">
                <div id="viewImageWrap" class="bg-light rounded-3 p-2 d-flex align-items-center justify-content-center" style="min-height: 200px; display: none;">
                  <img id="viewImage" style="max-width: 100%; border-radius: 8px; max-height: 250px;" />
                </div>
                <div id="noImageText" class="text-muted small mt-4" style="display:none;">No attachment provided</div>
              </div>

              <div class="col-12 mt-4">
                <label class="fw-bold mb-2">Status Progress</label>
                <div class="progress" style="height: 10px;">
                  <div id="viewProgressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="d-flex justify-content-between mt-2 small text-muted">
                  <span>Pending</span>
                  <span>On Process</span>
                  <span>Processed</span>
                </div>
              </div>

              <div class="col-12 mt-3" id="viewRemarksWrap" style="display: none">
                <div class="alert alert-success border-0 shadow-sm">
                    <h6 class="fw-bold text-success"><i class="bi bi-check-circle-fill me-2"></i>Resolution Details</h6>
                    <hr>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <small class="text-muted">Finished At</small>
                            <div class="fw-bold" id="viewFinishedAt"></div>
                        </div>
                         <div class="col-md-6">
                            <small class="text-muted">Problem Found</small>
                            <div class="fw-bold" id="viewRemarkFound"></div>
                        </div>
                        <div class="col-12">
                            <small class="text-muted">Solution Applied</small>
                            <div class="fw-bold" id="viewRemarkSolution"></div>
                        </div>
                         <div class="col-12">
                            <small class="text-muted">Recommendation</small>
                            <div class="fw-bold" id="viewRemarkRecommendation"></div>
                        </div>
                    </div>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer border-0 pt-0">
            <button id="cancelTicketBtn" class="btn btn-outline-danger">Cancel Ticket</button>
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="geminiChatModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px; overflow: hidden;">
          <div class="modal-header bg-primary text-white border-0">
            <h5 class="modal-title"><i class="bi bi-stars me-2"></i>VISTO AI Assistant</h5>
            <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body p-0 d-flex flex-column" style="height: 500px;">
            <div id="geminiMessages" class="flex-grow-1 p-3" style="overflow-y: auto; background: #f1f5f9;">
              <div class="gemini-message assistant">
                <div class="gemini-message-content">
                  Hi there! I'm the VISTO AI Assistant. I can help you troubleshoot common IT problems, explain dictionary terms, or guide you on submitting a ticket. How can I assist you today?
                </div>
              </div>
            </div>

            <div class="p-3 bg-white border-top">
              <div class="input-group">
                <input type="text" class="form-control border-end-0" id="geminiInput" placeholder="Ask a question..." />
                <button class="btn btn-primary" id="sendGemini"><i class="bi bi-send-fill"></i></button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // -------------------------------------------------------------
      // GEMINI API CONFIGURATION
      // -------------------------------------------------------------
      const GEMINI_API_KEY = "AIzaSyBZScERUEHWehEpQAo2rGmPFtmGBxixFz8";
      const GEMINI_API_ENDPOINT = `https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;

      let chatHistory = [];

      function appendGeminiMessage(sender, text) {
        const messagesContainer = document.getElementById("geminiMessages");
        if (!messagesContainer) return;

        const messageElem = document.createElement("div");
        messageElem.className = `gemini-message ${sender}`;
        const formattedText = text.replace(/\*\*(.*?)\*\*/g, "<b>$1</b>");
        messageElem.innerHTML = `<div class="gemini-message-content">${formattedText}</div>`;
        messagesContainer.appendChild(messageElem);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      async function sendToGemini() {
        const inputElement = document.getElementById("geminiInput");
        const sendButton = document.getElementById("sendGemini");
        if (!inputElement || !sendButton) return;

        const userMessage = inputElement.value.trim();
        if (!userMessage) return;

        appendGeminiMessage("user", userMessage);
        inputElement.value = "";
        sendButton.disabled = true;
        inputElement.placeholder = "AI is typing...";

        chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

        try {
          appendGeminiMessage(
            "assistant",
            '<div id="typingIndicator">...</div>'
          );
          const response = await fetch(GEMINI_API_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: chatHistory }),
          });

          if (!response.ok) throw new Error("AI Error");
          const data = await response.json();
          const assistantResponse =
            data.candidates?.[0]?.content?.parts?.[0]?.text ||
            "Sorry, I couldn't process that.";

          const typingIndicator = document.getElementById("typingIndicator");
          if (typingIndicator) typingIndicator.parentElement.remove();

          appendGeminiMessage("assistant", assistantResponse);
          chatHistory.push({
            role: "model",
            parts: [{ text: assistantResponse }],
          });
        } catch (error) {
          console.error("Gemini API Error:", error);
          const typingIndicator = document.getElementById("typingIndicator");
          if (typingIndicator) typingIndicator.parentElement.remove();
          chatHistory.pop();
          appendGeminiMessage(
            "assistant",
            "Sorry, I encountered an error connecting to the AI."
          );
        } finally {
          sendButton.disabled = false;
          inputElement.placeholder = "Ask the AI about an issue...";
        }
      }

      const sendGeminiBtn = document.getElementById("sendGemini");
      if (sendGeminiBtn) sendGeminiBtn.addEventListener("click", sendToGemini);

      const geminiInput = document.getElementById("geminiInput");
      if (geminiInput)
        geminiInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendToGemini();
          }
        });

      // -------------------------------------------------------------
      // APP LOGIC
      // -------------------------------------------------------------

      const $ = (sel, ctx = document) => ctx.querySelector(sel);
      const $$ = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));
      const nowStr = () => new Date().toLocaleString();

      // Ticket Form Logic
      const form = $("#ticketForm");
      const imageInput = $("#imageInput");
      const imagePreviewWrap = $("#imagePreviewWrap");
      const imagePreview = $("#imagePreview");
      const timeField = $("#timeField");

      function setTimeNow() {
        if (timeField) timeField.value = new Date().toLocaleString();
      }
      setTimeNow();
      setInterval(setTimeNow, 60000);

      let lastImageData = null;
      if (imageInput) {
        imageInput.addEventListener("change", () => {
          const f = imageInput.files && imageInput.files[0];
          if (!f) {
            if (imagePreviewWrap) imagePreviewWrap.style.display = "none";
            lastImageData = null;
            return;
          }
          const reader = new FileReader();
          reader.onload = (e) => {
            lastImageData = e.target.result;
            if (imagePreview) imagePreview.src = lastImageData;
            if (imagePreviewWrap) imagePreviewWrap.style.display = "block";
          };
          reader.readAsDataURL(f);
        });
      }

      // Ticket Loading Logic
      const ticketsList = $("#ticketsList");
      const noTickets = $("#noTickets");
      const ticketsLoading = $("#ticketsLoading");

      async function loadTickets() {
        // Safety checks before accessing style
        if (ticketsLoading) ticketsLoading.style.display = "block";
        if (ticketsList) ticketsList.style.display = "none";

        const { user } = await checkAuth();
        const uid = user.uid;

        db.collection("tickets")
          .where("userId", "==", uid)
          .onSnapshot(
            (snapshot) => {
              if (ticketsList) ticketsList.innerHTML = "";

              if (snapshot.empty) {
                if (noTickets) noTickets.style.display = "block";
                if (ticketsList) ticketsList.style.display = "none";
                if (ticketsLoading) ticketsLoading.style.display = "none";
                return;
              }

              if (noTickets) noTickets.style.display = "none";

              const tickets = [];
              snapshot.forEach((doc) => {
                const t = doc.data();
                t.__docId = doc.id;
                tickets.push(t);
              });

              tickets.sort((a, b) => {
                const ta =
                  a.createdAt && a.createdAt.seconds ? a.createdAt.seconds : 0;
                const tb =
                  b.createdAt && b.createdAt.seconds ? b.createdAt.seconds : 0;
                return tb - ta;
              });

              tickets.forEach((ticket) => {
                const row = document.createElement("div");
                row.className = "ticket-row";
                row.dataset.ticketId = ticket.__docId;

                const thumb = document.createElement("img");
                thumb.className = "ticket-thumb";
                thumb.src =
                  ticket.image ||
                  'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="90"><rect width="100%" height="100%" fill="%23eef6ee"/><text x="50%" y="50%" fill="%2399a89b" dominant-baseline="middle" text-anchor="middle" font-size="12">No image</text></svg>';

                const meta = document.createElement("div");
                meta.className = "ticket-meta";
                meta.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="ticket-id">${
                      ticket.id
                    } <span class="text-muted"> · ${ticket.issue}</span></div>
                    <div class="ticket-desc text-truncate" style="max-width: 300px;">${ticket.description}</div>
                    <div class="ticket-time"><i class="bi bi-clock me-1"></i> ${ticket.time}</div>
                  </div>
                  <div style="min-width:160px" class="text-end">
                    <div class="text-muted small mb-1">Status</div>
                    <span class="badge ${getBadgeClass(ticket.status)}">${getStatusDisplayText(ticket.status)}</span>
                  </div>
                </div>
                <div class="mt-3">
                  <div class="progress"><div class="progress-bar ${getProgressColor(
                    ticket.progress
                  )}" role="progressbar" style="width:${ticket.progress}%"></div></div>
                </div>
              `;

                const actions = document.createElement("div");
                actions.className = "d-flex flex-column ticket-actions";
                actions.innerHTML = `
                <div class="d-flex gap-2">
                  <button title="View details" class="btn btn-sm btn-light text-primary"><i class="bi bi-eye-fill"></i></button>
                  <button title="Cancel ticket" class="btn btn-sm btn-light text-danger"><i class="bi bi-trash-fill"></i></button>
                </div>
              `;

                actions
                  .querySelector(".btn-light.text-primary")
                  .addEventListener("click", (e) => {
                      e.stopPropagation();
                      openTicketModal(ticket.__docId, ticket);
                  });
                actions
                  .querySelector(".btn-light.text-danger")
                  .addEventListener("click", (e) => {
                      e.stopPropagation();
                      cancelTicket(ticket.__docId);
                  });

                // Row click also opens modal
                row.addEventListener("click", () => openTicketModal(ticket.__docId, ticket));

                row.appendChild(thumb);
                row.appendChild(meta);
                row.appendChild(actions);
                if (ticketsList) ticketsList.appendChild(row);
              });

              if (ticketsLoading) ticketsLoading.style.display = "none";
              if (ticketsList) ticketsList.style.display = "block";
            },
            (error) => {
              console.error("Error loading tickets:", error);
              if (ticketsLoading) ticketsLoading.style.display = "none";
            }
          );
      }

      function getBadgeClass(status) {
        if (status === "pending") return "bg-warning";
        if (status === "on-process") return "bg-info";
        if (status === "processed") return "bg-success";
        return "bg-secondary";
      }

      function getStatusDisplayText(status) {
        const statusMap = {
          pending: "Pending",
          "on-process": "On Process",
          processed: "Processed",
        };
        return statusMap[status] || status;
      }

      function getProgressColor(p) {
        if (p >= 100) return "bg-success";
        if (p >= 60) return "bg-info";
        return "bg-warning";
      }

      function uid() {
        return "T" + Date.now().toString(36).toUpperCase().slice(-6);
      }

      if (form) {
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const name = $("#name").value.trim();
          const schoolId = $("#schoolId").value.trim();
          const department = $("#department").value;
          const issue = $("#issueSelect").value || "Other";
          const description = $("#description").value.trim();
          const time = timeField.value || nowStr();

          if (!name || !schoolId || !department || !issue || !description) {
            alert("Please fill all required fields.");
            return;
          }

          const submitBtn = form.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.textContent = "Submitting...";
          submitBtn.disabled = true;

          try {
            const currentUser =
              firebase.auth().currentUser || (await checkAuth()).user;
            const newTicket = {
              id: uid(),
              userId: currentUser.uid,
              userEmail: currentUser.email,
              name: name,
              schoolId: schoolId,
              department: department,
              issue: issue,
              description: description,
              time: time,
              image: lastImageData || null,
              status: "pending",
              progress: 10,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            };

            await db.collection("tickets").add(newTicket);

            // --- EMAILJS NOTIFICATION LOGIC ---
            // Triggers automatically when a ticket is created
            await sendEmailNotification(currentUser.email, newTicket);
            // ----------------------------------

            $("#name").value = "";
            $("#schoolId").value = "";
            $("#department").value = "";
            $("#issueSelect").value = "";
            $("#description").value = "";
            if (imageInput) imageInput.value = "";
            if (imagePreviewWrap) imagePreviewWrap.style.display = "none";
            lastImageData = null;

            alert(
              "Ticket submitted successfully! Ticket ID: " +
                newTicket.id +
                "\nYou can view progress in My Tickets."
            );
          } catch (error) {
            console.error("Error submitting ticket:", error);
            alert("Error submitting ticket: " + error.message);
          } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
          }
        });
      }

      async function cancelTicket(ticketId) {
        if (!confirm("Cancel this ticket?")) return;
        try {
          await db.collection("tickets").doc(ticketId).delete();
        } catch (error) {
          console.error("Error canceling ticket:", error);
          alert("Error canceling ticket.");
        }
      }

      const ticketViewModalElem = $("#ticketViewModal");
      const ticketModal = new bootstrap.Modal(ticketViewModalElem);

      function openTicketModal(ticketId, ticket) {
        $("#viewIssue").textContent = ticket.issue;
        $("#viewDesc").textContent = ticket.description;
        $("#viewName").textContent = ticket.name;
        $("#viewSchoolId").textContent = ticket.schoolId;
        $("#viewDepartment").textContent = ticket.department;
        $("#viewTime").textContent = ticket.time;

        const viewImage = $("#viewImage");
        const viewImageWrap = $("#viewImageWrap");
        const noImageText = document.getElementById("noImageText");

        if (ticket.image && viewImage && viewImageWrap) {
          viewImage.src = ticket.image;
          viewImageWrap.style.display = "flex"; // changed to flex for centering
          noImageText.style.display = "none";
        } else if (viewImageWrap) {
          viewImageWrap.style.display = "none";
          noImageText.style.display = "block";
        }

        updateModalProgress(ticket);

        const cancelBtn = $("#cancelTicketBtn");
        if (cancelBtn)
          cancelBtn.onclick = function () {
            if (!confirm("Cancel this ticket?")) return;
            cancelTicket(ticketId);
            ticketModal.hide();
          };

        const viewRemarksWrap = $("#viewRemarksWrap");
        if (ticket.remarks && viewRemarksWrap) {
          $("#viewFinishedAt").textContent = ticket.finishedAt
            ? ticket.finishedAt.toDate
              ? ticket.finishedAt.toDate().toLocaleString()
              : ticket.finishedAt
            : "";
          $("#viewRemarkFound").textContent = ticket.remarks.found || "N/A";
          $("#viewRemarkSolution").textContent = ticket.remarks.solution || "N/A";
          $("#viewRemarkRecommendation").textContent =
            ticket.remarks.recommendation || "N/A";
          viewRemarksWrap.style.display = "block";
        } else if (viewRemarksWrap) {
          viewRemarksWrap.style.display = "none";
        }

        ticketModal.show();
      }

      function updateModalProgress(t) {
        const pb = $("#viewProgressBar");
        if (pb) {
          pb.style.width = t.progress + "%";
          // Remove text content inside bar for cleaner look, rely on width
          pb.className = "progress-bar " + getProgressColor(t.progress);
        }
      }

      // -------------------------------------------------------------
      // CHAT LOGIC
      // -------------------------------------------------------------
      let messageListener = null;

      function initializeChat() {
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) return;

        if (messageListener) {
          messageListener();
        }

        const messagesDiv = document.getElementById("chatMessages");
        const noMessages = document.getElementById("noMessages");

        messageListener = db
          .collection("chats")
          .where("conversationId", "==", currentUser.uid)
          .orderBy("timestamp", "asc")
          .onSnapshot(
            (snapshot) => {
              if (!messagesDiv) return; 

              if (snapshot.empty) {
                if (noMessages) noMessages.style.display = "block";
                messagesDiv.innerHTML = "";
                if (noMessages) messagesDiv.appendChild(noMessages);
                return;
              }

              if (noMessages) noMessages.style.display = "none";
              messagesDiv.innerHTML = "";

              snapshot.forEach((doc) => {
                const message = doc.data();
                const timestamp = message.timestamp
                  ? message.timestamp.toDate()
                  : new Date();
                const isMe = message.senderId === currentUser.uid;

                const messageElem = document.createElement("div");
                messageElem.className = `chat-message ${
                  isMe ? "user" : "admin"
                }`;

                messageElem.innerHTML = `
                  <div class="message-content">
                    ${message.text}
                    <div class="message-time">${timestamp.toLocaleTimeString(
                      [],
                      { hour: "2-digit", minute: "2-digit" }
                    )}</div>
                  </div>
                `;
                messagesDiv.appendChild(messageElem);
              });

              messagesDiv.scrollTop = messagesDiv.scrollHeight;
            },
            (error) => {
              console.error("Error loading chat messages:", error);
            }
          );
      }

      const sendMsgBtn = document.getElementById("sendMessage");
      if (sendMsgBtn)
        sendMsgBtn.addEventListener("click", async () => {
          const messageInput = document.getElementById("messageInput");
          const message = messageInput.value.trim();

          if (message) {
            try {
              const currentUser = firebase.auth().currentUser;
              await db.collection("chats").add({
                conversationId: currentUser.uid,
                senderId: currentUser.uid,
                userEmail: currentUser.email,
                text: message,
                senderType: "user",
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                readByAdmin: false,
                readByUser: true,
              });
              messageInput.value = "";
            } catch (error) {
              console.error("Error sending message:", error);
              alert("Failed to send message: " + error.message);
            }
          }
        });

      const msgInput = document.getElementById("messageInput");
      if (msgInput)
        msgInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            if (sendMsgBtn) sendMsgBtn.click();
          }
        });

      const clearAllBtn = document.getElementById("clearAll");
      if (clearAllBtn)
        clearAllBtn.addEventListener("click", async () => {
          if (!confirm("Clear all your tickets? This action cannot be undone."))
            return;
          try {
            const { user } = await checkAuth();
            const snapshot = await db
              .collection("tickets")
              .where("userId", "==", user.uid)
              .get();
            const batch = db.batch();
            snapshot.forEach((doc) => batch.delete(doc.ref));
            await batch.commit();
          } catch (error) {
            console.error("Error clearing tickets:", error);
          }
        });

      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) logoutBtn.addEventListener("click", () => logout());

      const initializeUserData = async () => {
        const waitForAuthReady = async (timeout = 3000) => {
          const start = Date.now();
          while (window.isAuthLoading === undefined || window.isAuthLoading) {
            if (Date.now() - start > timeout) break;
            await new Promise((r) => setTimeout(r, 100));
          }
        };

        await waitForAuthReady();

        try {
          const { user, userData } = await checkAuth();
          if (!user) {
            console.log("[user] No authenticated user found");
            return;
          }

          const name =
            (userData && (userData.name || userData.fullName)) ||
            user.displayName ||
            user.email ||
            "User";
          const badge = document.getElementById("user-badge");
          if (badge) badge.textContent = name;

          const nameInput = $("#name");
          if (nameInput && !nameInput.value.trim()) nameInput.value = name;

          loadTickets();
          initializeChat();
        } catch (err) {
          console.error("[user] Error initializing user data:", err);
        }
      };

      initializeUserData();
      firebase.auth().onAuthStateChanged(() => {
        console.log("[user] Auth state changed, reinitializing...");
        initializeUserData();
      });

      // -------------------------------------------------------------
      // EMAILJS SENDING FUNCTION
      // -------------------------------------------------------------
      async function sendEmailNotification(toEmail, ticketData) {
        // REPLACE THESE WITH YOUR ACTUAL IDs FROM EMAILJS DASHBOARD
        const serviceID = "service_4v7dh2w";
        const templateID = "template_cstixmf";

        // Must match variables in your EmailJS Template
        const templateParams = {
            to_name: ticketData.name,
            to_email: toEmail,
            ticket_id: ticketData.id,
            issue_category: ticketData.issue,
            ticket_description: ticketData.description,
            ticket_time: ticketData.time
        };

        try {
            await emailjs.send(serviceID, templateID, templateParams);
            console.log("Email sent via EmailJS successfully!");
        } catch (error) {
            console.error("EmailJS Error:", error);
        }
      }
    </script>
  </body>
</html>